<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/ui.xhtml">

<ui:define name="head">
    <style type="text/css">
        .col-label {
            text-align: right;
            font-size: 12px !important;
            font-weight: bold;
        }

        .col-input {
            width: 150px;
            font-size: 12px !important;
            text-align: left;
            font-weight: bold;
        }

        .col-label2 {
            width: 150px;
            font-size: 12px !important;
            text-align: right;
            font-weight: bold;
        }

        .col-input2 {
            font-size: 12px !important;
            text-align: left;
            font-weight: bold;
        }
    </style>
    <!--<style type="text/css">
        .datalist-noborder .ui-widget-content {
            border: none;
            color: #999999;
        }

        .help-row {
            vertical-align: top;
        }

        .input-col-s {
            width: 45px;
        }

        .input-col-m {
            width: 60px;
        }

        .input-col-l {
            width: 80px;
        }

        .input-col-xl {
            width: 140px;
        }
    </style>-->
    <script language="JavaScript" type="text/JavaScript">
        //<![CDATA[
        function KeyDown() {
            if (event.keyCode == 13) {
                if (event.srcElement.id == 'inputform:actnum') {
                    event.keyCode = 9;
                } else if (event.srcElement.id == 'inputform:txnamt') {
                    event.keyCode = 9;
                } else if (event.srcElement.id == 'inputform:rvslbl') {
                    event.keyCode = 9;
                } else if (event.srcElement.id == 'inputform:opnda2') {
                    event.keyCode = 9;
                } else if (event.srcElement.id == 'inputform:anacde') {
                    event.keyCode = 9;
                }
                if (event.srcElement.id == 'inputform:furinf') {
                    document.forms['inputform']['inputform:actno'].focus();
                    document.forms['inputform']['inputform:save'].click();
                } else if (event.srcElement.id == 'vchsetform:vchset') {
                    event.returnValue = false;
                    event.cancel = true;
                    document.forms['vchsetform']['vchsetform:modifyvchset'].click();
                } else if (event.srcElement.id == 'authform:password') {
                    event.returnValue = false;
                    event.cancel = true;
                    document.forms['authform']['authform:authlogin'].click();
                } else {
                    event.keyCode = 9;
                }
            }
            if (event.keyCode == 38) {
                if (event.srcElement.id == 'inputform:txnamt') {
                    document.forms['inputform']['inputform:actnum'].focus();
                } else if (event.srcElement.id == 'inputform:anacde') {
                    document.forms['inputform']['inputform:txnamt'].focus();
                } else if (event.srcElement.id == 'inputform:rvslbl') {
                    document.forms['inputform']['inputform:anacde'].focus();
                } else if (event.srcElement.id == 'inputform:opnda2') {
                    document.forms['inputform']['inputform:rvslbl'].focus();
                } else if (event.srcElement.id == 'inputform:furinf') {
                    document.forms['inputform']['inputform:opnda2'].focus();
                }
            }
        }

        function handleConfirmDeleteAll() {
            confirmDeleteAll.show();
            window.event.keyCode = 9;
            //jQuery(PrimeFaces.escapeClientId('confirmform:canceldeleteall')).focus();
        }

        function handleInputComplete(xhr, status, args, id, nextid) {
            if (args) {
                var isValid = args.isValid;
                if (!isValid) {
                    document.forms['inputform']['inputform:' + id].focus();
                } else {
                    if (id == 'valdat') {
                        var inputvaldat = document.forms['inputform']['inputform:valdat'].value;
                        var lastvaldat = document.forms['inputform']['inputform:lastvaldat'].value;
                        var vchaut = document.forms['inputform']['inputform:vchaut'].value;
                        var sysdate = document.forms['inputform']['inputform:sysdate'].value;
                        var tlrnum = document.forms['inputform']['inputform:tlrnum'].value;
                        if ((inputvaldat != "") && (inputvaldat != sysdate)
                                && (vchaut == "" || (vchaut != "" && inputvaldat != lastvaldat))) {
                            document.forms['authform']['authform:workuser'].value = tlrnum;
                            authdlg.show();
                            //jQuery(function(){jQuery(PrimeFaces.escapeClientId('authform:username')).focus();});
                            event.keyCode = 46;
                            //document.forms['authform']['authform:username'].focus;
                            jQuery(PrimeFaces.escapeClientId('authform:username')).focus();
                        }
                        if (inputvaldat == "") {
                            document.forms['inputform']['inputform:vchaut'].value = "";
                        }
                    }
                }
            }
        }

        function handleVchsetRequest(xhr, status, args) {
            if (args.validationFailed || !args.result) {
                jQuery('#dialog').effect("shake", { times: 3 }, 100);
            } else {
                vchsetdlg.hide();
            }
        }

        function handleLoginRequest(xhr, status, args) {
            if (args.validationFailed || !args.loggedIn) {
                jQuery('#authdialog').effect("shake", { times: 3 }, 100);
            } else {
                authdlg.hide();
                var vchaut = document.forms['authform']['authform:username'].value;
                document.forms['inputform']['inputform:lastvaldat'].value = document.forms['inputform']['inputform:valdat'].value;
                document.forms['inputform']['inputform:vchaut'].value = vchaut;
                document.forms['inputform']['inputform:anacde'].focus();
            }
        }

        var submitted = false;

        function checkDoubleSubmit(f) {
            //alert(submitted);
            if (submitted) {
                window.alert("请勿重复提交!");
                return false;
            } else {
                submitted = true;
                return true;
            }
        }
        //]]>
    </script>
</ui:define>

<ui:define name="content">
    <div class="entry" id="top">
        <h:form id="inputform" onsubmit="return checkDoubleSubmit(this);">
            <p:messages id="msgs" showDetail="true"/>
            <p:focus for="actnum"/>
            <p:panel header="【传票录入】 当前套号:[#{batchBookAction.vchset}]" id="input">
                <h:panelGrid id="addtable" columns="2" style="width: 100%">
                    <!--<h:panelGrid width="90%" style="padding-top:5px;padding-bottom:2px;font-weight: bold" columns="6" cellspacing="2"
                                 columnClasses="input-col-m,input-col-xl,input-col-m,input-col-xl,input-col-s,input-col-xl,input-col-l,input-col-xl">-->
                    <h:panelGrid id="adddat" columns="6" cellpadding="0" cellspacing="5" border="0" style="width:80%;"
                                 columnClasses="col-label2, col-input2, col-label2, col-input2, col-label2, col-input2">
                        <h:outputLabel value="帐号* :" for="actnum"/>
                        <p:inputText autocomplete="off" id="actnum" value="#{batchBookAction.m8401.ACTNUM}"
                                     onkeydown="KeyDown()" onfocus="this.select()" maxlength="14"
                                     required="true" requiredMessage="请正确输入账号">
                        </p:inputText>
                        <h:outputLabel value="交易金额* :" for="txnamt"/>
                        <h:inputText autocomplete="off" id="txnamt" value="#{batchBookAction.m8401.TXNAMT}"
                                     onkeydown="KeyDown()" onfocus="this.select()" style="text-align:right"
                                     required="true" requiredMessage="请正确输入金额">
                            <p:ajax event="blur" listener="#{batchBookAction.txnEvent}" update="msgs,txnamt"/>
                        </h:inputText>
                        <h:outputLabel value="摘要 :" for="anacde"/>
                        <h:inputText autocomplete="off" id="anacde" value="#{batchBookAction.m8401.FURINF}"
                                     onkeydown="KeyDown()" onfocus="this.select()">
                        </h:inputText>
                        <h:outputLabel value="冲正标志* :" for="rvslbl"/>
                        <p:inputMask autocomplete="off" id="rvslbl" value="#{batchBookAction.m8401.RVSLBL}"
                                     required="true" onkeydown="KeyDown()" onfocus="this.select()" mask="99">
                        </p:inputMask>
                        <h:outputLabel value="冲补/起息日* :" for="opnda2"/>
                        <h:inputText autocomplete="off" id="opnda2" value="#{batchBookAction.m8401.OPNDA2}"
                                     required="true" onkeydown="KeyDown()" onfocus="this.select()"
                                     requiredMessage="日期不能为空。"
                                     onclick="WdatePicker({dateFmt:'yyyyMMdd'})">
                        </h:inputText>
                        <h:outputLabel value="统计码 :" for="furinf"/>
                        <p:inputText autocomplete="off" id="furinf" value="#{batchBookAction.m8401.ANACDE}"
                                     onkeydown="KeyDown()" onfocus="this.select()" >
                        </p:inputText>

                    </h:panelGrid>
                    <h:panelGrid id="btns" columns="1" cellspacing="5" cellpadding="0" width="10%">
                        <p:commandButton id="save" value="确定" ajax="false" action="#{batchBookAction.onCreateNewRecord}"
                                         style="width:74px;" update="msgs,show,:dtform">
                        </p:commandButton>
                        <!--<p:commandButton id="t" value="打印" ajax="false"
                                         action="#{batchBookAction.onPrint()}"
                                         style="width:74px;" update="show,:dtform">
                        </p:commandButton>-->
                    </h:panelGrid>
                </h:panelGrid>
                <p:separator/><!--columnClasses="input-col-m,input-col-xl,input-col-m,input-col-xl,
                input-col-s,input-col-xl,input-col-l,input-col-xl"-->
                <h:panelGrid id="show" style="width: 82%" columns="8"
                             columnClasses="col-label2, col-input2, col-label2, col-input2, col-label2, col-input2 ,col-label2, col-input2">
                    <h:outputLabel value="贷方合计 :"/>
                    <h:inputText id="creditamt" value="#{batchBookAction.totalCreditAmt}" disabled="true"
                                 style="text-align:right">
                        <f:convertNumber type="number" pattern="###,###,###,###,##0.00"/>
                    </h:inputText>
                    <h:outputLabel value="借方合计 :"/>
                    <h:inputText id="debitamt" value="#{batchBookAction.totalDebitAmt}" disabled="true"
                                 style="text-align:right">
                        <f:convertNumber type="number" pattern="###,###,###,###,##0.00"/>
                    </h:inputText>
                    <h:outputLabel value="轧差 :"/>
                    <h:inputText id="totalamt" value="#{batchBookAction.totalAmt}" disabled="true"
                                 style="text-align:right">
                        <f:convertNumber type="number" pattern="#,###,###,###,##0.00"/>
                    </h:inputText>
                    <h:outputLabel value="传票套号 :"/>
                    <h:inputText value="#{batchBookAction.vchset}" disabled="true"
                                 style="text-align:right;">
                        <f:convertNumber type="number" pattern="0000"/>
                    </h:inputText>
                </h:panelGrid>
            </p:panel>

        </h:form>
        <h:form id="dtform" style="margin-top: 10px">
            <p:menubar>
                <p:menuitem value="【套平】" icon="ui-icon ui-icon-gear" type="push"
                            actionListener="#{batchBookAction.onBalanceAct()}"
                            ajax="false" update="pdt,dtform,msgs,addtable" process="@form"/>
                <p:menuitem value="【套修改】" icon="ui-icon ui-icon-pencil" type="push" onclick="vchsetdlg.show();
                             document.forms['vchsetform']['vchsetform:vchset'].focus();"/>
                <p:menuitem value="【套删除】" icon="ui-icon ui-icon-newwin" type="push"
                            ajax="false" update="pdt,dtform,msgs" process="@form"
                            onclick="vchsetdellg.show();
                            document.forms['vchsetform']['vchsetform:vchset'].focus();"
                        /><!--actionListener="#{batchBookAction.onDeleteVchset()}"-->
                <p:menuitem value="【多笔删除】" icon="ui-icon ui-icon-close"
                            action="#{batchBookAction.onMultiConfirm}" type="push"
                            ajax="false"/>
            </p:menubar>
            <p:ajaxStatus style="height:18px;text-align:center">
                <f:facet name="start">
                    <h:graphicImage value="/images/ajaxloadingbar.gif"/>
                </f:facet>
                <f:facet name="complete">
                    <h:outputText value=""/>
                </f:facet>
            </p:ajaxStatus>
            <p:dialog id="dialog" header="已套平传票修改" widgetVar="vchsetdlg" modal="true">
                <p:growl id="vchsetgrowl" globalOnly="true" showDetail="true"/>
                <h:panelGrid columns="1" cellpadding="5">
                    <h:outputLabel for="vchset" value="请输入传票套号: *" style="font-weight: bold"/>
                    <h:inputText value="#{batchBookAction.vchset}" onfocus="this.select()"
                                 id="vchset" required="true" label="vchset" onkeydown="KeyDown()">
                    </h:inputText>
                    <f:facet name="footer">
                        <p:commandButton id="modifyvchset" value="确定" update="pdt" ajax="false"
                                         actionListener="#{batchBookAction.onBoolVchset()}"
                                         oncomplete="vchsetdlg.hide();"/>
                        <p:commandButton value="取消" onclick="vchsetdlg.hide()" type="button"/>
                    </f:facet>
                </h:panelGrid>
            </p:dialog>
            <p:dialog id="dialog2" header="确认删除该套传票?" widgetVar="vchsetdellg" modal="true">
                <p:growl id="vchsetgrowl2" globalOnly="true" showDetail="true"/>
                <h:panelGrid columns="2" cellpadding="5">
                    <h:outputLabel for="vchset2" value="传票套号*: " style="font-weight: bold"/>
                    <h:outputText id="vchset2" value="#{batchBookAction.vchset}" style="font-weight: bold"/>
                    <f:facet name="footer">
                        <p:commandButton id="modifyvchset2" value="确定" update="pdt" ajax="false"
                                         actionListener="#{batchBookAction.onDeleteVchset()}"
                                         oncomplete="vchsetdlg.hide();"/>
                        <p:commandButton value="取消" onclick="vchsetdellg.hide()" type="button"/>
                    </f:facet>
                </h:panelGrid>
            </p:dialog>
            <p:dataTable id="addtable"  height="200" selection="#{batchBookAction.selectedRecords}"
                         value="#{batchBookAction.dataList}" var="record"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks}
                          {NextPageLink} {LastPageLink} {RowsPerPageDropdown} 最大总笔数：#{99}"
                         paginator="true" rows="10" paginatorPosition="bottom"
                         rowKey="#{record.SETSEQ}" rowsPerPageTemplate="100,50,15,10,5"
                         emptyMessage="传票记录为空..." style="margin-top:10px">

                <p:column selectionMode="multiple" style=" text-align:center;"/>

                <p:column headerText="序号" style="text-align:center" sortBy="#{record.SETSEQ}">
                    <h:outputText id="setseq" value="#{record.SETSEQ}"/>
                </p:column>
                <p:column headerText="帐号" style="text-align:center" sortBy="#{record.ACTNUM}">
                    <h:outputText value="#{record.ACTNUM}"/>
                </p:column>
                <p:column headerText="冲正标志" style="text-align:center" sortBy="#{record.RVSLBL}">
                    <h:outputText value="#{record.RVSLBL}"/>
                </p:column>
                <p:column headerText="交易金额" style="text-align:right" sortBy="#{record.TMPAMT}">
                    <h:outputText value="#{record.TMPAMT}">
                        <f:convertNumber pattern="###,###,###,###,##0.00"/>
                    </h:outputText>
                </p:column>
                <p:column headerText="摘要" style="text-align:center">
                    <h:outputText value="#{record.FURINF}"/>
                </p:column>
                <p:column headerText="冲补/起息日" style="text-align:center">
                    <h:outputText value="#{record.VALDAT}">
                    </h:outputText>
                </p:column>
                <p:column headerText="统计码" style="text-align:center">
                    <h:outputText value="#{record.ANACDE}"/>
                </p:column>
                <p:column headerText="附件" style="text-align:center">
                    <h:outputText value="#{record.VCHATT}"/>
                </p:column>

                <p:column headerText="操作" style="text-align:center">
                    <h:commandLink immediate="true" value="修改" style="color: blue" ajax="false"
                                   action="#{batchBookAction.onModifyRecord()}">
                        <f:param value="#{batchBookAction.vchset}" name="vchset"/>
                        <f:param value="#{record.SETSEQ}" name="setseq"/>
                        <f:param value="#{record.ACTNUM}" name="actnum"/>
                        <f:param value="#{record.TXNAMT}" name="txnamt"/>
                        <f:param value="#{record.RVSLBL}" name="rvslbl"/>
                        <f:param value="#{record.VALDAT}" name="valdat"/>
                        <f:param value="#{record.ANACDE}" name="anacde"/>
                        <f:param value="#{record.FURINF}" name="furinf"/>
                    </h:commandLink>
                    <p:spacer width="10px;"/>
                    <h:commandLink immediate="true" value="删除" style="color: blue" ajax="false"
                                   action="#{batchBookAction.onDeleteRecord()}">
                        <f:param value="#{batchBookAction.vchset}" name="vchset"/>
                        <f:param value="#{record.SETSEQ}" name="setseq"/>
                    </h:commandLink>
                </p:column>
            </p:dataTable>
        </h:form>
        <br/>
    </div>
    <div>
        <p:outputLabel style="font-size: 12px !important;font-weight: bold;color: grey;"
                       value="冲正标志：11-现金， 12-转账， 22-冲正， 52补账"/>
        <br/>
        <p:separator/>
    </div>
</ui:define>
</ui:composition>